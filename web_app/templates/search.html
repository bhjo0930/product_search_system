{% extends "base.html" %}

{% block title %}Search - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <div class="hero-section" style="padding: 4rem 0 2rem;">
        <h1 class="display-4" style="font-size: 2.5rem; margin: 0;">Product Search</h1>
        <p class="lead" style="margin: 0.5rem 0 0;">Find products using natural language</p>
    </div>

    <div class="content-grid">
        <!-- Search Form -->
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <!-- Search Type Selection -->
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 400; color: #1a1a1a; margin-bottom: 0.5rem;">Search Type</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="search_type" id="searchText" value="text" {% if not search_type or search_type == 'text' %}checked{% endif %} onchange="toggleSearchFields()">
                                <label class="form-check-label" for="searchText">Text Search</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="search_type" id="searchImage" value="image" {% if search_type == 'image' %}checked{% endif %} onchange="toggleSearchFields()">
                                <label class="form-check-label" for="searchImage">Image Search</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="search_type" id="searchMultimodal" value="multimodal" {% if search_type == 'multimodal' %}checked{% endif %} onchange="toggleSearchFields()">
                                <label class="form-check-label" for="searchMultimodal">Text + Image</label>
                            </div>
                        </div>
                    </div>

                    <!-- Text Search Field -->
                    <div class="mb-3" id="textSearchField">
                        <label for="query_text" class="form-label" style="font-weight: 400; color: #1a1a1a; margin-bottom: 0.5rem;">Search Query</label>
                        <textarea class="form-control" 
                                id="query_text" 
                                name="query_text" 
                                rows="3" 
                                placeholder="Describe the product you're looking for...&#10;e.g., summer t-shirt for hot weather&#10;e.g., comfortable running shoes for sports">{{ query if query else '' }}</textarea>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666666;">
                            AI understands context and finds the most similar products.
                        </div>
                    </div>

                    <!-- Image Search Field -->
                    <div class="mb-3" id="imageSearchField" style="display: none;">
                        <label for="search_image" class="form-label" style="font-weight: 400; color: #1a1a1a; margin-bottom: 0.5rem;">Search Image</label>
                        <input type="file" class="form-control" id="search_image" name="search_image" accept="image/*" onchange="previewSearchImage(this)">
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666666;">
                            Upload an image to find similar products (JPG, PNG, GIF, WebP)
                        </div>
                        
                        <!-- Image Preview -->
                        <div id="searchImagePreview" style="margin-top: 1rem; display: none;">
                            <img id="searchPreviewImg" src="" alt="Search image preview" style="max-width: 200px; max-height: 150px; border: 1px solid #e8e8e8; border-radius: 4px;">
                            <div style="margin-top: 0.5rem;">
                                <button type="button" class="btn btn-success btn-sm me-2" onclick="analyzeSearchImage()">
                                    <i class="fas fa-magic me-1"></i>AI 분석하기
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeSearchImage()">Remove Image</button>
                            </div>
                            <!-- AI 분석 결과 표시 -->
                            <div id="searchAnalysisResult" style="margin-top: 1rem; display: none;">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-brain me-2"></i>AI 분석 결과</h6>
                                    <div id="searchAnalysisContent"></div>
                                    <div style="margin-top: 1rem;">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="appendSearchAnalysis()">
                                            <i class="fas fa-plus me-1"></i>검색어에 추가하기
                                        </button>
                                        <button type="button" class="btn btn-warning btn-sm" onclick="replaceSearchAnalysis()">
                                            <i class="fas fa-sync me-1"></i>검색어 교체하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Search Products</button>
                </form>
            </div>
        </div>

        <!-- Search Results -->
        {% if results %}
        <div>
            <div style="margin-bottom: 2rem;">
                <h3 class="section-title">Search Results</h3>
                <p class="text-secondary">{{ results|length }} products found{% if query %} for "{{ query }}"{% endif %}</p>
            </div>
            
            <div class="card-grid" style="gap: 1rem;">
                {% for result in results %}
                <div class="card hover-shadow {% if result.similarity >= 0.7 %}similarity-high{% elif result.similarity >= 0.5 %}similarity-medium{% else %}similarity-low{% endif %}">
                    <div class="card-body">
                        <!-- Product Image -->
                        {% if result.image_path %}
                        <div class="text-center mb-3">
                            {% if result.image_path.startswith('https://') %}
                                <img src="{{ result.image_path }}" 
                                     alt="Product image" 
                                     style="max-width: 100%; height: 150px; object-fit: cover; border-radius: 4px;">
                            {% else %}
                                <img src="{{ url_for('static', filename=result.image_path) }}" 
                                     alt="Product image" 
                                     style="max-width: 100%; height: 150px; object-fit: cover; border-radius: 4px;">
                            {% endif %}
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 style="font-size: 0.9rem; color: #666666; margin-bottom: 0.5rem;">
                                    {{ result.product_id }}
                                </h6>
                                {% set lines = result.text_content.split('\n') %}
                                {% if lines|length > 0 %}
                                <h5 class="mb-2" style="font-size: 1.1rem; font-weight: 400;">{{ lines[0][:60] }}{% if lines[0]|length > 60 %}...{% endif %}</h5>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <div class="badge" style="background: {% if result.similarity >= 0.7 %}#27ae60{% elif result.similarity >= 0.5 %}#f39c12{% else %}#e74c3c{% endif %}; color: white; font-size: 0.7rem;">
                                    {{ "%.1f" | format(result.similarity * 100) }}%
                                </div>
                                {% if result.created_at %}
                                <div style="font-size: 0.7rem; color: #999999; margin-top: 0.25rem;">
                                    {{ result.created_at[:10] }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="content-preview mb-3">
                            {% set lines = result.text_content.split('\n') %}
                            {% if lines|length > 1 %}
                            <p style="color: #666666; font-size: 0.9rem; line-height: 1.5; margin: 0;">
                                {% for line in lines[1:4] %}
                                    {% if line.strip() %}
                                    {{ line[:100] }}{% if line|length > 100 %}...{% endif %}
                                    {% if not loop.last %} {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </p>
                            {% endif %}
                        </div>
                        
                        <a href="{{ url_for('product_detail', product_id=result.product_id) }}" 
                           class="btn btn-success" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                            View Details
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% elif request.method == 'POST' %}
        <div class="card">
            <div class="card-body text-center" style="padding: 4rem 2rem;">
                <i class="fas fa-search" style="font-size: 3rem; color: #999999; margin-bottom: 2rem;"></i>
                <h4 style="color: #666666; font-weight: 300; margin-bottom: 1rem;">No results found</h4>
                <p style="color: #999999; margin-bottom: 0;">Try searching with different keywords.</p>
            </div>
        </div>
        {% endif %}

        <!-- Search Tips -->
        {% if not results and request.method != 'POST' %}
        <div class="card">
            <div class="card-body">
                <h3 class="section-title text-center">Search Tips</h3>
                <div class="row">
                    <div class="col-md-6">
                        <h6 style="color: #1a1a1a; font-weight: 400; margin-bottom: 1rem;">Examples</h6>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 0.5rem; color: #666666;">"summer t-shirt for hot weather"</li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">"comfortable running shoes for sports"</li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">"warm winter jacket with padding"</li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">"travel backpack for hiking"</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 style="color: #1a1a1a; font-weight: 400; margin-bottom: 1rem;">Features</h6>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 0.5rem; color: #666666;">Text and image search</li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">Multimodal AI understanding</li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">Similarity scoring</li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">Visual search results</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle search fields based on search type
function toggleSearchFields() {
    const searchType = document.querySelector('input[name="search_type"]:checked').value;
    const textField = document.getElementById('textSearchField');
    const imageField = document.getElementById('imageSearchField');
    const queryTextarea = document.getElementById('query_text');
    
    if (searchType === 'text') {
        textField.style.display = 'block';
        imageField.style.display = 'none';
        queryTextarea.required = true;
    } else if (searchType === 'image') {
        textField.style.display = 'none';
        imageField.style.display = 'block';
        queryTextarea.required = false;
    } else if (searchType === 'multimodal') {
        textField.style.display = 'block';
        imageField.style.display = 'block';
        queryTextarea.required = false;
    }
}

// Image preview functionality for search
function previewSearchImage(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('searchPreviewImg').src = e.target.result;
            document.getElementById('searchImagePreview').style.display = 'block';
            
            // 멀티모달 검색 모드일 때 자동 분석 실행
            const searchType = document.querySelector('input[name="search_type"]:checked').value;
            if (searchType === 'multimodal') {
                // 잠시 후 자동 분석 (사용자가 이미지를 확인할 시간 제공)
                setTimeout(() => {
                    analyzeSearchImage();
                }, 1000);
            }
        };
        reader.readAsDataURL(file);
    }
}

function removeSearchImage() {
    document.getElementById('search_image').value = '';
    document.getElementById('searchImagePreview').style.display = 'none';
    document.getElementById('searchPreviewImg').src = '';
    document.getElementById('searchAnalysisResult').style.display = 'none';
}

// 검색 이미지 AI 분석 기능
let currentSearchAnalysis = '';

function analyzeSearchImage() {
    const fileInput = document.getElementById('search_image');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('먼저 이미지를 선택해주세요.');
        return;
    }
    
    const analyzeBtn = document.querySelector('button[onclick="analyzeSearchImage()"]');
    const originalText = analyzeBtn.innerHTML;
    
    // 로딩 상태로 변경
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>분석 중...';
    analyzeBtn.disabled = true;
    
    // FormData 생성
    const formData = new FormData();
    formData.append('image', file);
    
    // API 호출
    fetch('/analyze_image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentSearchAnalysis = data.analysis;
            document.getElementById('searchAnalysisContent').innerHTML = 
                '<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">' + 
                data.analysis + '</pre>';
            document.getElementById('searchAnalysisResult').style.display = 'block';
        } else {
            alert('분석 실패: ' + (data.error || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('분석 중 오류가 발생했습니다.');
    })
    .finally(() => {
        // 버튼 상태 복원
        analyzeBtn.innerHTML = originalText;
        analyzeBtn.disabled = false;
    });
}

function appendSearchAnalysis() {
    if (!currentSearchAnalysis) return;
    
    const textarea = document.getElementById('query_text');
    const currentText = textarea.value;
    const separator = currentText ? '\n\n--- AI 분석 결과 ---\n' : '';
    
    textarea.value = currentText + separator + currentSearchAnalysis;
    
    alert('AI 분석 결과가 검색어에 추가되었습니다.');
}

function replaceSearchAnalysis() {
    if (!currentSearchAnalysis) return;
    
    if (confirm('기존 검색어를 AI 분석 결과로 교체하시겠습니까?')) {
        const textarea = document.getElementById('query_text');
        textarea.value = currentSearchAnalysis;
        
        alert('검색어가 AI 분석 결과로 교체되었습니다.');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleSearchFields();
});
</script>
{% endblock scripts %}