{% extends "base.html" %}

{% block title %}상품 수정 - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <div class="hero-section" style="padding: 4rem 0 2rem;">
        <h1 class="display-4" style="font-size: 2.5rem; margin: 0;">
            <i class="fas fa-edit text-primary me-3"></i>상품 수정
        </h1>
        <p class="lead" style="margin: 0.5rem 0 0;">상품 정보를 수정하고 AI가 새로운 임베딩을 생성합니다</p>
    </div>

    <div class="content-grid">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        상품 ID: {{ product_id }}
                    </h5>
                    <div>
                        <a href="{{ url_for('product_detail', product_id=product_id) }}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>상세로 돌아가기
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <!-- 상품 정보 입력 -->
                    <div class="mb-4">
                        <label for="content" class="form-label" style="font-weight: 400; color: #1a1a1a; margin-bottom: 0.5rem;">
                            <i class="fas fa-align-left me-2"></i>상품 정보
                        </label>
                        <textarea class="form-control" 
                                id="content" 
                                name="content" 
                                rows="10" 
                                required
                                placeholder="상품의 상세 정보를 입력하세요...&#10;예시:&#10;블루 코튼 티셔츠&#10;색상: 파란색&#10;소재: 100% 코튼&#10;사이즈: S, M, L, XL&#10;&#10;특징:&#10;- 부드러운 코튼 소재&#10;- 편안한 착용감&#10;- 일상복으로 적합">{{ product.text_content }}</textarea>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666666;">
                            AI가 이 정보를 분석하여 검색 가능한 임베딩을 생성합니다.
                        </div>
                    </div>

                    <!-- 현재 이미지 표시 -->
                    {% if product.image_path %}
                    <div class="mb-4">
                        <label class="form-label" style="font-weight: 400; color: #1a1a1a; margin-bottom: 0.5rem;">
                            <i class="fas fa-image me-2"></i>현재 이미지
                        </label>
                        <div>
                            {% if product.image_path.startswith('https://') %}
                                <img src="{{ product.image_path }}" 
                                     alt="현재 상품 이미지" 
                                     style="max-width: 200px; max-height: 150px; object-fit: cover; border: 1px solid #e8e8e8; border-radius: 4px;">
                            {% else %}
                                <img src="{{ url_for('static', filename=product.image_path) }}" 
                                     alt="현재 상품 이미지" 
                                     style="max-width: 200px; max-height: 150px; object-fit: cover; border: 1px solid #e8e8e8; border-radius: 4px;">
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 새 이미지 업로드 -->
                    <div class="mb-4">
                        <label for="image" class="form-label" style="font-weight: 400; color: #1a1a1a; margin-bottom: 0.5rem;">
                            <i class="fas fa-camera me-2"></i>새 이미지 (선택사항)
                        </label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*" onchange="previewImage(this)">
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666666;">
                            새 이미지를 선택하면 기존 이미지가 교체됩니다. (JPG, PNG, GIF, WebP)
                        </div>
                        
                        <!-- 새 이미지 미리보기 -->
                        <div id="imagePreview" style="margin-top: 1rem; display: none;">
                            <img id="previewImg" src="" alt="미리보기" style="max-width: 200px; max-height: 150px; border: 1px solid #e8e8e8; border-radius: 4px;">
                            <div style="margin-top: 0.5rem;">
                                <button type="button" class="btn btn-success btn-sm me-2" onclick="analyzeImage()">
                                    <i class="fas fa-magic me-1"></i>AI 분석하기
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeImage()">이미지 제거</button>
                            </div>
                            <!-- AI 분석 결과 표시 -->
                            <div id="analysisResult" style="margin-top: 1rem; display: none;">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-brain me-2"></i>AI 분석 결과</h6>
                                    <div id="analysisContent"></div>
                                    <div style="margin-top: 1rem;">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="appendAnalysis()">
                                            <i class="fas fa-plus me-1"></i>텍스트에 추가하기
                                        </button>
                                        <button type="button" class="btn btn-warning btn-sm" onclick="replaceAnalysis()">
                                            <i class="fas fa-sync me-1"></i>텍스트 교체하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 제출 버튼 -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>수정 완료
                        </button>
                        <a href="{{ url_for('product_detail', product_id=product_id) }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>취소
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 수정 안내 -->
        <div class="card">
            <div class="card-body">
                <h3 class="section-title text-center">수정 안내</h3>
                <div class="row">
                    <div class="col-md-6">
                        <h6 style="color: #1a1a1a; font-weight: 400; margin-bottom: 1rem;">
                            <i class="fas fa-info-circle text-info me-2"></i>자동 처리
                        </h6>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 0.5rem; color: #666666;">
                                <i class="fas fa-check text-success me-2"></i>새 임베딩 자동 생성
                            </li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">
                                <i class="fas fa-check text-success me-2"></i>검색 결과 즉시 반영
                            </li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">
                                <i class="fas fa-check text-success me-2"></i>이미지 크기 자동 최적화
                            </li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">
                                <i class="fas fa-check text-success me-2"></i>수정 시간 자동 기록
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 style="color: #1a1a1a; font-weight: 400; margin-bottom: 1rem;">
                            <i class="fas fa-lightbulb text-warning me-2"></i>팁
                        </h6>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 0.5rem; color: #666666;">
                                <i class="fas fa-arrow-right text-primary me-2"></i>상세한 정보일수록 검색 정확도 향상
                            </li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">
                                <i class="fas fa-arrow-right text-primary me-2"></i>키워드를 다양하게 포함하면 좋음
                            </li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">
                                <i class="fas fa-arrow-right text-primary me-2"></i>이미지는 상품을 잘 보여주는 것으로
                            </li>
                            <li style="margin-bottom: 0.5rem; color: #666666;">
                                <i class="fas fa-arrow-right text-primary me-2"></i>수정 후 유사 상품 검색으로 확인 가능
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 이미지 미리보기 기능
function previewImage(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

function removeImage() {
    document.getElementById('image').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('previewImg').src = '';
    document.getElementById('analysisResult').style.display = 'none';
}

// 이미지 AI 분석 기능
let currentAnalysis = '';

function analyzeImage() {
    const fileInput = document.getElementById('image');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('먼저 이미지를 선택해주세요.');
        return;
    }
    
    const analyzeBtn = document.querySelector('button[onclick="analyzeImage()"]');
    const originalText = analyzeBtn.innerHTML;
    
    // 로딩 상태로 변경
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>분석 중...';
    analyzeBtn.disabled = true;
    
    // FormData 생성
    const formData = new FormData();
    formData.append('image', file);
    
    // API 호출
    fetch('/analyze_image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentAnalysis = data.analysis;
            document.getElementById('analysisContent').innerHTML = 
                '<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">' + 
                data.analysis + '</pre>';
            document.getElementById('analysisResult').style.display = 'block';
        } else {
            alert('분석 실패: ' + (data.error || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('분석 중 오류가 발생했습니다.');
    })
    .finally(() => {
        // 버튼 상태 복원
        analyzeBtn.innerHTML = originalText;
        analyzeBtn.disabled = false;
    });
}

function appendAnalysis() {
    if (!currentAnalysis) return;
    
    const textarea = document.getElementById('content');
    const currentText = textarea.value;
    const separator = currentText ? '\n\n--- AI 분석 결과 ---\n' : '';
    
    textarea.value = currentText + separator + currentAnalysis;
    
    alert('AI 분석 결과가 텍스트에 추가되었습니다.');
}

function replaceAnalysis() {
    if (!currentAnalysis) return;
    
    if (confirm('기존 텍스트를 AI 분석 결과로 교체하시겠습니까?')) {
        const textarea = document.getElementById('content');
        textarea.value = currentAnalysis;
        
        alert('텍스트가 AI 분석 결과로 교체되었습니다.');
    }
}

// 폼 제출 시 확인
document.querySelector('form').addEventListener('submit', function(e) {
    const content = document.getElementById('content').value.trim();
    if (!content) {
        e.preventDefault();
        alert('상품 정보를 입력해주세요.');
        return false;
    }
    
    // 제출 버튼 비활성화 (중복 제출 방지)
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>처리 중...';
});
</script>
{% endblock scripts %}