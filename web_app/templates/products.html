{% extends "base.html" %}

{% block title %}Products - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <div class="hero-section" style="padding: 4rem 0 2rem;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-4" style="font-size: 2.5rem; margin: 0;">Products</h1>
                <p class="lead" style="margin: 0.5rem 0 0;">Manage your product catalog</p>
            </div>
            <a href="{{ url_for('add_product') }}" class="btn btn-primary">Add Product</a>
        </div>
    </div>

    {% if products %}
    <div class="content-grid">
        <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 2rem;">
            <p class="text-secondary" style="margin: 0;">{{ products|length }} products found</p>
            
            <!-- Sorting Options -->
            <div class="d-flex gap-2 align-items-center">
                <span style="font-size: 0.9rem; color: #666666;">Sort by:</span>
                <select class="form-select" style="width: auto; font-size: 0.9rem;" onchange="applySorting(this.value)">
                    <option value="created_at-desc" {% if sort_by == 'created_at' and order == 'desc' %}selected{% endif %}>Newest first</option>
                    <option value="created_at-asc" {% if sort_by == 'created_at' and order == 'asc' %}selected{% endif %}>Oldest first</option>
                    <option value="name-asc" {% if sort_by == 'name' and order == 'asc' %}selected{% endif %}>Name A-Z</option>
                    <option value="name-desc" {% if sort_by == 'name' and order == 'desc' %}selected{% endif %}>Name Z-A</option>
                    <option value="id-asc" {% if sort_by == 'id' and order == 'asc' %}selected{% endif %}>ID Ascending</option>
                    <option value="id-desc" {% if sort_by == 'id' and order == 'desc' %}selected{% endif %}>ID Descending</option>
                </select>
            </div>
        </div>
        
        <div class="card-grid" style="gap: 1rem;">
            {% for product in products %}
            <div class="card hover-shadow">
                <div class="card-body">
                    <!-- Product Image -->
                    {% if product.image_path %}
                    <div class="text-center mb-3">
                        {% if product.image_path.startswith('https://') %}
                            <img src="{{ product.image_path }}" 
                                 alt="Product image" 
                                 style="max-width: 100%; height: 150px; object-fit: cover; border-radius: 4px;">
                        {% else %}
                            <img src="{{ url_for('static', filename=product.image_path) }}" 
                                 alt="Product image" 
                                 style="max-width: 100%; height: 150px; object-fit: cover; border-radius: 4px;">
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="card-title" style="font-size: 0.9rem; color: #666666; margin-bottom: 0.5rem;">
                                {{ product.id }}
                            </h6>
                            {% set lines = product.content.split('\n') %}
                            {% if lines|length > 0 %}
                            <h5 class="mb-2" style="font-size: 1.1rem; font-weight: 400;">{{ lines[0][:60] }}{% if lines[0]|length > 60 %}...{% endif %}</h5>
                            {% endif %}
                        </div>
                        <span class="badge text-secondary" style="font-size: 0.7rem;">
                            {{ product.created_at[:10] if product.created_at else 'No date' }}
                        </span>
                    </div>
                    
                    <div class="content-preview mb-3">
                        <p class="card-text" style="color: #666666; font-size: 0.9rem; line-height: 1.5;">
                            {{ product.preview[:120] }}{% if product.preview|length > 120 %}...{% endif %}
                        </p>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('product_detail', product_id=product.id) }}" 
                           class="btn btn-success" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                            View Details
                        </a>
                        <button type="button" 
                                class="btn btn-danger" 
                                style="font-size: 0.8rem; padding: 0.5rem 1rem;"
                                onclick="confirmDelete('{{ product.id }}')">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="content-grid">
        <div class="card">
            <div class="card-body text-center" style="padding: 4rem 2rem;">
                <i class="fas fa-box-open" style="font-size: 3rem; color: #999999; margin-bottom: 2rem;"></i>
                <h4 style="color: #666666; font-weight: 300; margin-bottom: 1rem;">No products found</h4>
                <p style="color: #999999; margin-bottom: 2rem;">Start by adding your first product!</p>
                <a href="{{ url_for('add_product') }}" class="btn btn-primary">Add Product</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="font-weight: 400; color: #1a1a1a;">
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p style="color: #1a1a1a; margin-bottom: 1rem;">Are you sure you want to delete this product?</p>
                <p style="color: #666666; font-size: 0.9rem; margin: 0;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #e8e8e8;">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete(productId) {
    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = `/delete/${productId}`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function applySorting(value) {
    const [sort, order] = value.split('-');
    const url = new URL(window.location);
    url.searchParams.set('sort', sort);
    url.searchParams.set('order', order);
    window.location.href = url.toString();
}
</script>
{% endblock %}