{% extends "base.html" %}

{% block title %}상품 상세 - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-box text-primary me-3"></i>
                상품 상세 정보
            </h2>
            <div>
                <a href="{{ url_for('products') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>목록으로
                </a>
                <a href="{{ url_for('edit_product', product_id=product_id) }}" class="btn btn-primary">
                    <i class="fas fa-edit me-1"></i>수정
                </a>
                <button type="button" 
                        class="btn btn-outline-danger" 
                        onclick="confirmDelete('{{ product_id }}')">
                    <i class="fas fa-trash me-1"></i>삭제
                </button>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            상품 ID: {{ product_id }}
                        </h5>
                    </div>
                    <div class="col-auto">
                        {% if product.created_at %}
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-calendar me-1"></i>
                            등록일: {{ product.created_at[:10] }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- 상품 이미지 표시 -->
                {% if product.image_path %}
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-image me-2"></i>상품 이미지
                        </h6>
                        <div class="text-center">
                            {% if product.image_path.startswith('https://') %}
                                <img src="{{ product.image_path }}" 
                                     alt="상품 이미지" 
                                     class="img-fluid rounded shadow-sm"
                                     style="max-width: 400px; max-height: 300px; object-fit: cover; cursor: pointer;"
                                     onclick="showImageModal(this.src)">
                            {% else %}
                                <img src="{{ url_for('static', filename=product.image_path) }}" 
                                     alt="상품 이미지" 
                                     class="img-fluid rounded shadow-sm"
                                     style="max-width: 400px; max-height: 300px; object-fit: cover; cursor: pointer;"
                                     onclick="showImageModal(this.src)">
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-8">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-align-left me-2"></i>상품 정보
                        </h6>
                        <div class="product-content">
                            {% set lines = product.text_content.split('\n') %}
                            {% for line in lines %}
                                {% if line.strip() %}
                                    {% if loop.first %}
                                    <h4 class="text-primary mb-3">{{ line }}</h4>
                                    {% elif line.startswith('[') and line.endswith(']') %}
                                    <h5 class="text-success">{{ line }}</h5>
                                    {% elif ':' in line and line.split(':')[0]|length < 20 %}
                                    <div class="row mb-2">
                                        <div class="col-3">
                                            <strong class="text-secondary">{{ line.split(':')[0] }}:</strong>
                                        </div>
                                        <div class="col-9">
                                            {{ line.split(':')[1:] | join(':') }}
                                        </div>
                                    </div>
                                    {% elif line.startswith('-') %}
                                    <li class="text-muted">{{ line[1:].strip() }}</li>
                                    {% elif line.strip() in ['상품 특징:', '특징:', '기능:'] %}
                                    <h6 class="text-info mt-3 mb-2">{{ line }}</h6>
                                    <ul class="list-unstyled">
                                    {% else %}
                                    <p class="mb-2">{{ line }}</p>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-chart-pie me-2"></i>기술 정보
                        </h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="mb-3">
                                    <small class="text-muted">임베딩 차원</small>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-brain text-warning me-2"></i>
                                        <span class="fw-bold">{{ product.text_embedding|length if product.text_embedding else 0 }}차원</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">임베딩 모델</small>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-microchip text-info me-2"></i>
                                        <span class="fw-bold">Gemini Embedding</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">저장소</small>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-database text-success me-2"></i>
                                        <span class="fw-bold">Firestore</span>
                                    </div>
                                </div>
                                {% if product.created_at %}
                                <div>
                                    <small class="text-muted">등록 시간</small>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-clock text-secondary me-2"></i>
                                        <span class="fw-bold">{{ product.created_at[:19].replace('T', ' ') }}</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 빠른 검색 -->
                        <div class="card mt-3">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-search me-2"></i>유사 상품 찾기
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-3">이 상품과 유사한 상품을 검색해보세요.</p>
                                
                                <!-- 내부 시스템 검색 -->
                                <div class="mb-3">
                                    <h6 class="small fw-bold text-primary mb-2">
                                        <i class="fas fa-database me-1"></i>내부 시스템 검색
                                    </h6>
                                    <form action="{{ url_for('search') }}" method="POST">
                                        {% set product_title = product.text_content.split('\n')[0] if product.text_content else '' %}
                                        <input type="hidden" name="query_text" value="{{ product_title }}">
                                        <button type="submit" class="btn btn-success btn-sm w-100">
                                            <i class="fas fa-search me-1"></i>내부 유사 상품 검색
                                        </button>
                                    </form>
                                    <small class="text-muted">등록된 상품 중에서 검색</small>
                                </div>

                                <!-- 외부 시스템 검색 -->
                                <div>
                                    <h6 class="small fw-bold text-info mb-2">
                                        <i class="fas fa-globe me-1"></i>외부 시스템 검색
                                    </h6>
                                    <button type="button" class="btn btn-info btn-sm w-100" onclick="searchExternal('{{ product_id }}')">
                                        <i class="fas fa-external-link-alt me-1"></i>웹에서 유사 상품 검색
                                    </button>
                                    <small class="text-muted">Google 검색으로 온라인 상품 검색</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    상품 삭제 확인
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>정말로 이 상품을 삭제하시겠습니까?</p>
                <p class="text-muted small">삭제된 상품은 복구할 수 없습니다.</p>
                <div class="bg-light p-2 rounded">
                    <strong>상품 ID:</strong> {{ product_id }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <form id="deleteForm" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>삭제
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 이미지 확대 모달 -->
{% if product.image_path %}
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-image text-primary me-2"></i>
                    상품 이미지
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="확대된 상품 이미지" class="img-fluid rounded">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <a id="downloadLink" href="" download class="btn btn-primary">
                    <i class="fas fa-download me-1"></i>이미지 다운로드
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 외부 검색 결과 모달 -->
<div class="modal fade" id="externalSearchModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-globe text-info me-2"></i>
                    웹 검색 결과
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 로딩 상태 -->
                <div id="searchLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">검색 중...</span>
                    </div>
                    <p class="mt-3 text-muted">AI가 검색어를 생성하고 Google에서 검색 중입니다...</p>
                </div>

                <!-- 검색 결과 -->
                <div id="searchResults" style="display: none;">
                    <!-- 검색어 표시 -->
                    <div class="alert alert-info">
                        <h6 class="mb-2">
                            <i class="fas fa-brain me-2"></i>AI 생성 검색어
                        </h6>
                        <div id="generatedQuery" class="fw-bold"></div>
                    </div>

                    <!-- 결과 목록 -->
                    <div id="resultsList"></div>
                </div>

                <!-- 오류 메시지 -->
                <div id="searchError" style="display: none;">
                    <div class="alert alert-danger">
                        <h6 class="mb-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>검색 오류
                        </h6>
                        <div id="errorMessage"></div>
                        <div id="setupGuide" class="mt-3" style="display: none;">
                            <h6 class="small">설정 안내:</h6>
                            <div id="setupSteps"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete(productId) {
    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = `/delete/${productId}`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// 이미지 확대 모달
function showImageModal(imageSrc) {
    const modalImage = document.getElementById('modalImage');
    const downloadLink = document.getElementById('downloadLink');
    
    modalImage.src = imageSrc;
    downloadLink.href = imageSrc;
    
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

// 외부 검색 기능
function searchExternal(productId) {
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('externalSearchModal'));
    modal.show();
    
    // 초기 상태 설정
    document.getElementById('searchLoading').style.display = 'block';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchError').style.display = 'none';
    
    // API 호출
    fetch(`/external_search/${productId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('searchLoading').style.display = 'none';
            
            if (data.success) {
                // 성공시 결과 표시
                document.getElementById('generatedQuery').textContent = data.query;
                displaySearchResults(data.results);
                document.getElementById('searchResults').style.display = 'block';
            } else {
                // 오류시 오류 메시지 표시
                displaySearchError(data.error, data.details, data.setup_guide);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            document.getElementById('searchLoading').style.display = 'none';
            displaySearchError('네트워크 오류가 발생했습니다.', error.message);
        });
}

function displaySearchResults(results) {
    const resultsList = document.getElementById('resultsList');
    
    if (!results || results.length === 0) {
        resultsList.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle me-2"></i>검색 결과가 없습니다.
            </div>
        `;
        return;
    }
    
    let html = `<h6 class="mb-3">검색 결과 (${results.length}개)</h6>`;
    
    results.forEach((result, index) => {
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">
                            <a href="${result.link}" target="_blank" class="text-decoration-none">
                                ${result.title}
                            </a>
                        </h6>
                        <small class="text-muted">${result.displayLink}</small>
                    </div>
                    <p class="card-text text-muted small mb-2">${result.snippet}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-success">${result.formattedUrl}</small>
                        <a href="${result.link}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>방문
                        </a>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsList.innerHTML = html;
}

function displaySearchError(errorMessage, details, setupGuide) {
    document.getElementById('searchError').style.display = 'block';
    document.getElementById('errorMessage').textContent = errorMessage;
    
    if (details) {
        document.getElementById('errorMessage').innerHTML += `<br><small class="text-muted">${details}</small>`;
    }
    
    if (setupGuide && Array.isArray(setupGuide)) {
        document.getElementById('setupGuide').style.display = 'block';
        const stepsHtml = setupGuide.map(step => `<div class="small text-muted">• ${step}</div>`).join('');
        document.getElementById('setupSteps').innerHTML = stepsHtml;
    }
}
</script>
{% endblock %}